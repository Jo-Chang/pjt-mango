{% extends 'base.html' %}
{% load static %}

{% block content %}

<header class="all-head bg-secondary-subtle text-center" style="height: 15rem;">
  <p class="m-0">25&27s Plates</p>
  <p class="text-body-tertiary fs-1">모든 가게</p>
</header>

<main class="container d-flex flex-column align-items-center">
  {% for store in stores %}
  <section class="food-thumbnail-section border-bottom">

    <div class="all-likes">
      <form class="like-forms" data-store-id={{ store.pk }}>
        {% csrf_token %}
        <button id="like-{{ store.pk }}" class='bg-transparent border-0'>
          {% if request.user in store.like_users.all %}
          <i class="bi bi-star-fill text-orange fs-1"></i>
          {% else %}
          <i class="bi bi-star fs-1"></i>
          {% endif %}
          <p class=''>즐겨찾기</p>
        </button>
      </form>
    </div>
      

    <div class="d-flex m-0">
      <div class="food-thumbnail-block float-start">
        <a href="{% url 'stores:detail' store.pk %}" class="text-decoration-none">
          {% if store.thumbnail %}
          <img src="{{ store.thumbnail.url }}" alt="Thumbnail Food Image" class="food-thumbnail-img">
          {% else %}
          <img src="{% static 'empty-food.jpg' %}" alt="Empty Food Image" class="food-thumbnail-img">
          {% endif %}
        </a>
      </div>
      
      
      <div class="my-auto d-flex flex-column flex-fill ">
        <p class="fs-1 m-0">
          <a href="{% url 'stores:detail' store.pk %}" class="text-dark">{{ store.name }}</a>
          <span class="text-orange">평균 평점이 들어갈곳{{ store.rating }}</span>
        </p>
        <p class="text-warning-emphasis fs-2 m-0">{{ store.category }}</p>
        <p class="text-body-tertiary fs-2">
          {% if store.address %}
            {{ store.address }}
          {% else %}
            주소 미등록
          {% endif %}
        </p>
        <a href="{% url 'stores:detail' store.pk %}" class="text-body-tertiary mt-3 align-self-end">{{ store.name }} 더보기 ></a>
  
      </div>
    </div>

  </section>
  {% endfor %}
</main>
{% endblock content %}


{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const forms = document.querySelectorAll('.like-forms')
  const csrftoken = document.querySelector('.like-forms>[name=csrfmiddlewaretoken]').value

  forms.forEach((form) => {
    form.addEventListener('submit', (event) => {
      event.preventDefault()
      const storeId = event.target.dataset.storeId
      
      axios({
        method: 'post',
        url: `/stores/${storeId}/like-stores/`,
        headers: {'X-CSRFToken': csrftoken,},
      })
      .then((response) => {
        const isLiked = response.data.is_liked
        const likeBtn = document.querySelector(`#like-${storeId}`)
        const iTag = document.querySelector(`#like-${storeId}>i`)
        
        console.log(svgTag)
        if (isLiked) {
          svgTag.setAttribute('class', 'bi bi-star-fill')
          svgTag.setAttribute('fill', 'orange')
          pathTag.setAttribute('d', 'M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z')
        } else {
          svgTag.setAttribute('class', 'bi bi-star')
          svgTag.setAttribute('fill', 'currentColor')
          pathTag.setAttribute('d', 'M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957a.565.565 0 0 0-.163-.505L1.71 6.745l4.052-.576a.525.525 0 0 0 .393-.288L8 2.223l1.847 3.658a.525.525 0 0 0 .393.288l4.052.575-2.906 2.77a.565.565 0 0 0-.163.506l.694 3.957-3.686-1.894a.503.503 0 0 0-.461 0z')
        }
        console.log(svgTag)
      })
      .catch((error) => {
        console.log(error.response)
      })
      })
    })
</script>
{% endblock script %}